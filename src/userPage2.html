<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTI || Campo Manolo</title>

    <link href="css/estilo-comun.css" rel="stylesheet" type="text/css">
    <link href="css/estilo-userPage.css" rel="stylesheet" type="text/css">
    <style>
        #mapa {
            width: 100%;
            margin: 0 auto;
            height: 70%;
            background-color: blue;
        }

        #selector-parcelas {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: .5cm;
        }
    </style>

</head>

<body>
    <header class="cabecera" role="banner">
        <a href="index.html" id="logo">
            <img src="images/LogoGTI.png" alt="logo de GTI" id="logo">
        </a>
        <div id="login-y-menu">
            <!-- aquí va el menu desplegable-->
            <div class="respmenu" id="menu">
                <img src="images/menu-hamburger.svg" alt="Icono del menu Hambuerguesa" id="menu">
                <input type="checkbox">
                <i class="fas fa-bars"></i>
                <i class="fas fa-times"></i>
                <nav>
                    <ul>
                        <li><a href="index.html">Cerrar sesión</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
</body>


<section class="user">
    <h1 class="titulo" id="titulo-User">¡Bienvenido M.Mira!</h1>

    <div class="cuadro" id="cuadro">
        <!-- imagen del fondo del editAdmin-->
        <!-- Comienzo de menú desplegable para observar la información de los campos -->

        <div id="parte_izquierda_y_arriba">
            <div class="cont-menu">

                <div class="cont-enlace">

                    <div class="cultivos">
                        <p> Campo 1 </p>
                        <p class="icono"> + </p>
                    </div>

                    <div class="enlace">
                        <button type="button" onclick="mostrarCampo1Sonda1()" class="sonda"> Sonda 1 </button>
                        <button type="button" onclick="mostrarCampo1Sonda2()" class="sonda"> Sonda 2 </button>
                    </div>

                </div>

            </div>

            <div class="cont-menu">

                <div class="cont-enlace">

                    <div class="cultivos">
                        <p> Campo 2 </p>
                        <p class="icono"> + </p>
                    </div>

                    <div class="enlace">
                        <button type="button" onclick="mostrarCampo2Sonda1()" class="sonda"> Sonda 1 </button>
                    </div>

                </div>
            </div>
            <img src="images/Sonda_5.png" alt="Imagen sensores" id="Grafica_Campo1_Sonda1">
            <img src="images/Sonda_6.png" alt="Imagen sensores" id="Grafica_Campo1_Sonda2">
            <img src="images/Sonda_7.png" alt="Imagen sensores" id="Grafica_Campo2_Sonda1">
            
        </div>

        
        
        
    </div>
    <div id="mapa"></div>
    <div id="selector-parcelas"></div>
</section>
<script src="js/menuUser.js"></script>
<script src="js/mostrarSensores.js"></script>

<script>
    let map;
    let parcelas;
    async function initMap() {

        let urlParams = new URLSearchParams(window.location.search);
        let usuario = urlParams.get("usuario");
        if (!usuario) usuario = 1;

        let consulta = await fetch("api/v1.0/parcela?usuario=" + usuario);
        parcelas = await consulta.json();
        console.log(parcelas);
        crearSelector();

        map = new google.maps.Map(document.getElementById('mapa'), {
            center: { lat: 38.9965055, lng: -0.1674364 },
            zoom: 15,
            mapTypeId: 'hybrid',
            styles: [
                {
                    featureType: 'poi',
                    stylers: [{ visibility: 'off' }]
                },
                {
                    featureType: 'transit',
                    stylers: [{ visibility: 'off' }]
                }
            ],
            mapTypeControl: false,
            streetViewControl: false,
            rotateControl: false,
        });
        map.setTilt(0);
    }

    function crearSelector() {
        let selector = document.getElementById("selector-parcelas")
        parcelas.forEach(function (parcela, index) {
            let label = document.createElement('label');
            label.textContent = parcela.nombre_parcela;
            let check = document.createElement('input');
            check.type = 'checkbox';
            check.addEventListener('change', function () {
                mostrarOcultarParcela(index, check.checked);
            })
            label.prepend(check)
            selector.append(label);
        })
    }

    async function mostrarOcultarParcela(index, mostrar) {
        let parcela = parcelas[index];
        if (mostrar) {
            if (parcela.polygon) {
                parcela.polygon.setMap(map);
            } else {
                let consulta = await fetch("api/v1.0/parcela/" + parcela.parcela + "/vertices");
                let vertices = await consulta.json();
                parcela.polygon = new google.maps.Polygon({
                    paths: vertices,
                    strokeColor: "#" + parcela.color,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#" + parcela.color,
                    fillOpacity: 0.35,
                    map: map
                });
            }
        } else {
            if (parcela.polygon) parcela.polygon.setMap(null);
        }
        ajustarMapa()
    }

    function ajustarMapa() {
        let bounds = new google.maps.LatLngBounds();
        parcelas.forEach(function (parcela) {
            if (parcela.polygon && parcela.polygon.getMap()) {
                parcela.polygon.getPath().getArray().forEach(function (v) {
                    bounds.extend(v);
                })
            }
        })
        if (!bounds.isEmpty()) map.fitBounds(bounds);
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js&callback=initMap" async defer></script>


</body>

</html>